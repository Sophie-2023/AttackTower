#include <iostream>

#include "EtatExploitation.h"
#include "EtatEnRoute.h"
#include "Carte.h"
#include "Loup.h"
#include "Chasseur.h"

EtatExploitation::EtatExploitation(Lieu* foret_, TroupeManager* tm, sf::RenderWindow* win)
    : State(tm, win), foret(foret_) {
  barreProgression.setSize({50.f, 5.f});
  barreProgression.setFillColor(sf::Color::Blue);
}

void EtatExploitation::agir(Troupe& troupe, sf::Time elapsedTime) {
  //std::cout << "J'exploite la foret" << std::endl;
  sf::Vector2f pos = troupe.getPosition();
  barreProgression.setPosition({pos.x - 20, pos.y - 40});

  float proportion = 1.f - (tempsEcoule.asSeconds() / tempsTotal.asSeconds());
  proportion = std::clamp(proportion, 0.f, 1.f);  // éviter valeur négative

  barreProgression.setSize({50.f * proportion, 5.f});

  tempsEcoule += elapsedTime;
  // Si le temps écoulé dépasse le temps total, on change d'état
  if (tempsEcoule >= tempsTotal) {
    std::unique_ptr<EtatEnRoute> etatEnRoute = std::make_unique<EtatEnRoute>(troupeManager->getCarte()->getBase(), troupeManager, window);

    std::unique_ptr<Troupe> newTroupe;
    if (dynamic_cast<Loup*>(&troupe)) {
      newTroupe = troupeManager->creerTroupe("loup", foret);
    } else if (dynamic_cast<Chasseur*>(&troupe)) {
      newTroupe = troupeManager->creerTroupe("chasseur", foret);
    }

    newTroupe->setIsInBase(false);
    troupeManager->ajouterTroupe(std::move(newTroupe));
    troupe.changerEtat(std::move(etatEnRoute));
    return;
  }
 
}

void EtatExploitation::draw(sf::RenderWindow& window) const {
  window.draw(barreProgression);
}